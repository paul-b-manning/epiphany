---
# Kubernetes worker node specific

- name: Check if node is currently registered with kubernetes cluster
  shell: kubectl --kubeconfig=/home/{{ admin_user.name }}/.kube/config get nodes --no-headers | awk '{print $1}' | grep -w {{ inventory_hostname }}
  register: node_already_in_cluster
  failed_when: node_already_in_cluster.rc == 2 or node_already_in_cluster.stderr # do not fail when grep doesn't match but detect errors in pipeline
  changed_when: false
  delegate_to: "{{ groups['master'][0] }}"

- name: Get token from master
  shell: kubeadm token list | grep -w authentication | grep -vwi invalid | awk '{print $1}' | head -1
  register: kubeadm_valid_token
  failed_when: kubeadm_valid_token.rc != 0 or kubeadm_valid_token.stderr # detect errors in pipeline
  changed_when: false
  delegate_to: "{{ groups['master'][0] }}"
  when: not node_already_in_cluster.stdout

- name: Create new token
  command: kubeadm token create --ttl 4h --description "Token generated by Epiphany for 'kubeadm join'."
  register: kubeadm_new_token
  delegate_to: "{{ groups['master'][0] }}"
  when:
    - not node_already_in_cluster.stdout
    - not kubeadm_valid_token.stdout

- name: Get CA key hash
  shell: >-
    openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null |
    openssl dgst -sha256 -hex | sed 's/^.* //'
  register: kubeadm_cert_hash
  delegate_to: "{{ groups['master'][0] }}"
  changed_when: false
  when: not node_already_in_cluster.stdout

- name: Join kubernetes
  shell: >-
    kubeadm join {{ hostvars[groups['master'][0]]['ansible_default_ipv4']['address'] }}:6443 --token {{ kubeadm_token }}
    --discovery-token-ca-cert-hash sha256:{{ kubeadm_cert_hash.stdout }}
  vars:
    kubeadm_token: "{{ kubeadm_valid_token.stdout if kubeadm_valid_token.stdout else kubeadm_new_token.stdout_lines[-1] }}"
  when:
    - not groups['master'][0] == inventory_hostname
    - not node_already_in_cluster.stdout

- name: Configure kubelet
  include_role:
    name: kubernetes-common
    tasks_from: configure-kubelet

- name: Create /home/{{ admin_user.name }}/.kube
  file:
    state: directory
    path: /home/{{ admin_user.name }}/.kube
    owner: "{{ admin_user.name }}"
    group: "{{ admin_user.name }}"

- name: Copy kubelet.conf as /home/{{ admin_user.name }}/.kube/config
  copy:
    src: /etc/kubernetes/kubelet.conf
    dest: /home/{{ admin_user.name }}/.kube/config
    remote_src: yes
    owner: "{{ admin_user.name }}"
    group: "{{ admin_user.name }}"
  when: not groups['master'][0] == inventory_hostname
